#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: MQTT S7 Connector
# Ensure default and example configuration files exist
# ==============================================================================

set -euo pipefail

CONFIG_DIR="/config"
STANDARD_BLUEPRINT="/usr/share/mqtt-s7-connector/standard-config.yaml"
EXAMPLE_SOURCE_DIR="/usr/src/mqtt-s7-connector"

bashio::log.info "Preparing MQTT S7 Connector configuration files..."

# Copy upstream example files when they are present in the cloned repository.
if [ -f "${EXAMPLE_SOURCE_DIR}/config.example.yaml" ]; then
    cp -n "${EXAMPLE_SOURCE_DIR}/config.example.yaml" "${CONFIG_DIR}/config.example.yaml"
fi

if [ -f "${EXAMPLE_SOURCE_DIR}/config.example.json" ]; then
    cp -n "${EXAMPLE_SOURCE_DIR}/config.example.json" "${CONFIG_DIR}/config.example.json"
fi

# Install the standard blueprint as the default config.yaml when none exists yet.
if [ -f "${STANDARD_BLUEPRINT}" ] && [ ! -f "${CONFIG_DIR}/config.yaml" ]; then
    bashio::log.info "Installing default config.yaml from standard blueprint"
    cp "${STANDARD_BLUEPRINT}" "${CONFIG_DIR}/config.yaml"
fi

# Provide the blueprint alongside the examples for quick manual duplication.
if [ -f "${STANDARD_BLUEPRINT}" ]; then
    cp -n "${STANDARD_BLUEPRINT}" "${CONFIG_DIR}/standard-config.yaml"
fi
